import{_ as a}from"./plugin-vue_export-helper-DlAUqK2U.js";import{o as e,c as t,f as n}from"./app-uJW8EvoO.js";const s={},i=n(`<p>昨晚我正在床上睡得着着的，突然来了一条短信。 <img src="https://cdn.nlark.com/yuque/0/2023/jpeg/12651402/1686489020512-2856e4de-e07f-472a-b4bf-692ea0c74e29.jpeg#averageHue=%23437f0d&amp;clientId=u8c354205-a028-4&amp;from=paste&amp;height=500&amp;id=uc066f531&amp;originHeight=500&amp;originWidth=500&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=67032&amp;status=done&amp;style=none&amp;taskId=u08cb1f6d-9adc-418f-9973-2363c96d722&amp;title=&amp;width=500" alt="手机图片.jpeg" loading="lazy"> 什么？线上的订单无法取消！ 我赶紧登录线上系统，查看业务日志。 <img src="https://cdn.nlark.com/yuque/0/2023/png/12651402/1686489028695-856ac076-eb33-4096-af12-ceadaf5a4261.png#averageHue=%232c3235&amp;clientId=u8c354205-a028-4&amp;from=paste&amp;height=796&amp;id=u926e8021&amp;originHeight=796&amp;originWidth=1958&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=532491&amp;status=done&amp;style=none&amp;taskId=uc3015ea4-c69e-4be7-b51e-158b0dbd516&amp;title=&amp;width=1958" alt="image-20220805234433155.png" loading="lazy"> 发现有<strong>MySQL锁超时</strong>的错误日志。 不用想，肯定有另一个事务正在修改这条订单，持有这条订单的锁。 导致当前事务获取不到锁，一直等待，直到超过锁超时时间，然后报错。 既然问题已经清楚了，接下来就轮到怎么排查一下到底是哪个事务正在持有这条订单的锁。 好在MySQL提供了丰富的工具，帮助我们排查锁竞争问题。</p><p>现场复现一个这个问题： 创建一张用户表，造点数据：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">\`</span>user<span class="token punctuation">\`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;主键ID&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>name<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;&#39;</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;姓名&#39;</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>事务1，更新id=1的用户姓名，不提交事务：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">begin</span><span class="token punctuation">;</span>
<span class="token keyword">update</span> <span class="token keyword">user</span> <span class="token keyword">set</span> name<span class="token operator">=</span><span class="token string">&#39;一灯&#39;</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>事务2，删除id=1的数据，这时候会产生锁等待：</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>begin;
delete from user where id=1;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>接下来，我们就通过MySQL提供的锁竞争统计表，排查一下锁等待问题： 先查一下锁等待情况：</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>select * from information_schema.innodb_lock_waits;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="https://cdn.nlark.com/yuque/0/2023/png/12651402/1686489045714-de20211e-69f5-4886-8d2d-7b09f669dc36.png#averageHue=%23f0f0ef&amp;clientId=u8c354205-a028-4&amp;from=paste&amp;height=252&amp;id=ue37e08ed&amp;originHeight=252&amp;originWidth=1122&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=111604&amp;status=done&amp;style=none&amp;taskId=u7cf31a39-a946-4f8a-ab98-3a7766069a2&amp;title=&amp;width=1122" alt="image-20220805230315814.png" loading="lazy"> 可以看到有一个锁等待的事务。 然后再查一下正在竞争的锁有哪些？</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>select * from information_schema.innodb_locks;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://cdn.nlark.com/yuque/0/2023/png/12651402/1686489054565-641a35bb-a0b7-4ba2-8d7c-c5833958c0d3.png#averageHue=%23f5f5f4&amp;clientId=u8c354205-a028-4&amp;from=paste&amp;height=276&amp;id=uae111877&amp;originHeight=276&amp;originWidth=1908&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=184077&amp;status=done&amp;style=none&amp;taskId=u3df54f03-10d1-4e43-973a-ce56f2dc446&amp;title=&amp;width=1908" alt="image-20220805230652982.png" tabindex="0" loading="lazy"><figcaption>image-20220805230652982.png</figcaption></figure><p>可以看到，MySQL统计的非常详细：</p><blockquote><p>lock_trx_id 表示事务ID lock_mode 表示排它锁还是共享锁 lock_type 表示锁定的记录，还是范围 lock_table 锁的表名 lock_index 锁定的是主键索引</p></blockquote><p>再查一下正在执行的事务有哪些？</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>select * from information_schema.innodb_trx;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="https://cdn.nlark.com/yuque/0/2023/png/12651402/1686489064064-4c1f7f12-c433-47fd-8d81-360477b2eb8b.png#averageHue=%23ecedeb&amp;clientId=u8c354205-a028-4&amp;from=paste&amp;height=362&amp;id=udebc2df6&amp;originHeight=362&amp;originWidth=1976&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=148258&amp;status=done&amp;style=none&amp;taskId=u27ac2b69-239f-4866-bda5-2f18f2db783&amp;title=&amp;width=1976" alt="image-20220805231412311.png" loading="lazy"> 可以清楚的看到正在执行的事务有两个，一个状态是锁等待（<code>LOCK WAIT</code>），正在执行的SQL也打印出来了：</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>delete from user where id=1;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>正是事务2的删除语句。 不用问，第二条，显示正在运行状态（<code>RUNNING</code>）的事务就是正在持有锁的事务1，MySQL线程id（<code>trx_mysql_thread_id</code>）是193。 我们用MySQL线程id查一下事务线程id：</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>select * from performance_schema.threads where processlist_id=193;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="https://cdn.nlark.com/yuque/0/2023/png/12651402/1686489073707-98e94d80-de9d-41e8-9e9e-abad539be193.png#averageHue=%23f1f1f0&amp;clientId=u8c354205-a028-4&amp;from=paste&amp;height=334&amp;id=u4886fb7a&amp;originHeight=334&amp;originWidth=1970&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=125016&amp;status=done&amp;style=none&amp;taskId=u02eb1656-118a-4eac-b236-621001b2c1f&amp;title=&amp;width=1970" alt="image-20220805232352034.png" loading="lazy"> 找到对应的事务线程id是218，然后再找一下这个线程正在执行的SQL语句：</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>select THREAD_ID,CURRENT_SCHEMA,SQL_TEXT 
from performance_schema.events_statements_current 
where thread_id=218;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://cdn.nlark.com/yuque/0/2023/png/12651402/1686489082985-ab31c8dd-d8e1-4f8d-9514-dc8aacf2ce83.png#averageHue=%23ebedec&amp;clientId=u8c354205-a028-4&amp;from=paste&amp;height=322&amp;id=u907801a2&amp;originHeight=322&amp;originWidth=1962&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=130731&amp;status=done&amp;style=none&amp;taskId=u589c71af-a038-430e-82a8-8812b8dda89&amp;title=&amp;width=1962" alt="image-20220805233523949.png" loading="lazy"> 可以清楚的看到这个线程正在执行的SQL语句就是事务1的update语句。 持有锁的SQL语句找到了，接下来再去找对应的业务代码也就轻而易举了。 以上是基于MySQL5.7版本，在MySQL8.0版本中有些命令已经删除了，替换成了其他命令，下篇文章再讲一下MySQL8.0怎么定位<strong>MySQL锁超时</strong>问题。</p>`,23),p=[i];function o(d,l){return e(),t("div",null,p)}const m=a(s,[["render",o],["__file","timeout.html.vue"]]),u=JSON.parse('{"path":"/mysql/timeout.html","title":"","lang":"zh-CN","frontmatter":{"description":"昨晚我正在床上睡得着着的，突然来了一条短信。 手机图片.jpeg 什么？线上的订单无法取消！ 我赶紧登录线上系统，查看业务日志。 image-20220805234433155.png 发现有MySQL锁超时的错误日志。 不用想，肯定有另一个事务正在修改这条订单，持有这条订单的锁。 导致当前事务获取不到锁，一直等待，直到超过锁超时时间，然后报错。 既然...","head":[["meta",{"property":"og:url","content":"https://vuepress-theme-hope-docs-demo.netlify.app/mysql/timeout.html"}],["meta",{"property":"og:site_name","content":"Java八股文网"}],["meta",{"property":"og:description","content":"昨晚我正在床上睡得着着的，突然来了一条短信。 手机图片.jpeg 什么？线上的订单无法取消！ 我赶紧登录线上系统，查看业务日志。 image-20220805234433155.png 发现有MySQL锁超时的错误日志。 不用想，肯定有另一个事务正在修改这条订单，持有这条订单的锁。 导致当前事务获取不到锁，一直等待，直到超过锁超时时间，然后报错。 既然..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://cdn.nlark.com/yuque/0/2023/jpeg/12651402/1686489020512-2856e4de-e07f-472a-b4bf-692ea0c74e29.jpeg#averageHue=%23437f0d&clientId=u8c354205-a028-4&from=paste&height=500&id=uc066f531&originHeight=500&originWidth=500&originalType=binary&ratio=1&rotation=0&showTitle=false&size=67032&status=done&style=none&taskId=u08cb1f6d-9adc-418f-9973-2363c96d722&title=&width=500"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"article:author","content":"Mr.Hope"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"\\",\\"image\\":[\\"https://cdn.nlark.com/yuque/0/2023/jpeg/12651402/1686489020512-2856e4de-e07f-472a-b4bf-692ea0c74e29.jpeg#averageHue=%23437f0d&clientId=u8c354205-a028-4&from=paste&height=500&id=uc066f531&originHeight=500&originWidth=500&originalType=binary&ratio=1&rotation=0&showTitle=false&size=67032&status=done&style=none&taskId=u08cb1f6d-9adc-418f-9973-2363c96d722&title=&width=500\\",\\"https://cdn.nlark.com/yuque/0/2023/png/12651402/1686489028695-856ac076-eb33-4096-af12-ceadaf5a4261.png#averageHue=%232c3235&clientId=u8c354205-a028-4&from=paste&height=796&id=u926e8021&originHeight=796&originWidth=1958&originalType=binary&ratio=1&rotation=0&showTitle=false&size=532491&status=done&style=none&taskId=uc3015ea4-c69e-4be7-b51e-158b0dbd516&title=&width=1958\\",\\"https://cdn.nlark.com/yuque/0/2023/png/12651402/1686489045714-de20211e-69f5-4886-8d2d-7b09f669dc36.png#averageHue=%23f0f0ef&clientId=u8c354205-a028-4&from=paste&height=252&id=ue37e08ed&originHeight=252&originWidth=1122&originalType=binary&ratio=1&rotation=0&showTitle=false&size=111604&status=done&style=none&taskId=u7cf31a39-a946-4f8a-ab98-3a7766069a2&title=&width=1122\\",\\"https://cdn.nlark.com/yuque/0/2023/png/12651402/1686489054565-641a35bb-a0b7-4ba2-8d7c-c5833958c0d3.png#averageHue=%23f5f5f4&clientId=u8c354205-a028-4&from=paste&height=276&id=uae111877&originHeight=276&originWidth=1908&originalType=binary&ratio=1&rotation=0&showTitle=false&size=184077&status=done&style=none&taskId=u3df54f03-10d1-4e43-973a-ce56f2dc446&title=&width=1908\\",\\"https://cdn.nlark.com/yuque/0/2023/png/12651402/1686489064064-4c1f7f12-c433-47fd-8d81-360477b2eb8b.png#averageHue=%23ecedeb&clientId=u8c354205-a028-4&from=paste&height=362&id=udebc2df6&originHeight=362&originWidth=1976&originalType=binary&ratio=1&rotation=0&showTitle=false&size=148258&status=done&style=none&taskId=u27ac2b69-239f-4866-bda5-2f18f2db783&title=&width=1976\\",\\"https://cdn.nlark.com/yuque/0/2023/png/12651402/1686489073707-98e94d80-de9d-41e8-9e9e-abad539be193.png#averageHue=%23f1f1f0&clientId=u8c354205-a028-4&from=paste&height=334&id=u4886fb7a&originHeight=334&originWidth=1970&originalType=binary&ratio=1&rotation=0&showTitle=false&size=125016&status=done&style=none&taskId=u02eb1656-118a-4eac-b236-621001b2c1f&title=&width=1970\\",\\"https://cdn.nlark.com/yuque/0/2023/png/12651402/1686489082985-ab31c8dd-d8e1-4f8d-9514-dc8aacf2ce83.png#averageHue=%23ebedec&clientId=u8c354205-a028-4&from=paste&height=322&id=u907801a2&originHeight=322&originWidth=1962&originalType=binary&ratio=1&rotation=0&showTitle=false&size=130731&status=done&style=none&taskId=u589c71af-a038-430e-82a8-8812b8dda89&title=&width=1962\\"],\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Mr.Hope\\",\\"url\\":\\"https://mister-hope.com\\"}]}"]]},"headers":[],"git":{"createdTime":null,"updatedTime":null,"contributors":[]},"readingTime":{"minutes":3.39,"words":1018},"filePathRelative":"mysql/timeout.md","autoDesc":true}');export{m as comp,u as data};
