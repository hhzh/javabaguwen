import{_ as a}from"./plugin-vue_export-helper-DlAUqK2U.js";import{o as n,c as s,f as e}from"./app-uJW8EvoO.js";const t={},p=e(`<h1 id="死锁现象" tabindex="-1"><a class="header-anchor" href="#死锁现象"><span>死锁现象</span></a></h1><p>线上MySQL死锁了，我赶紧登录线上系统，查看业务日志。 <img src="https://cdn.nlark.com/yuque/0/2023/png/12651402/1686487279908-fb9503ee-dc2e-45a5-9332-b29e80dd4e2a.png#averageHue=%23384656&amp;clientId=u4c0071e8-710e-4&amp;from=paste&amp;height=752&amp;id=ub2cf7df7&amp;originHeight=752&amp;originWidth=1262&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=963676&amp;status=done&amp;style=none&amp;taskId=u61a98b77-4b6d-4707-9f33-b3e04d5c600&amp;title=&amp;width=1262" alt="image-20220608112347888.png" loading="lazy"> 能清楚看到是这条insert语句发生了死锁。 MySQL如果检测到两个事务发生了死锁，会回滚其中一个事务，让另一个事务执行成功。很明显，我们这条insert语句被回滚了。</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">user</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">&#39;张三&#39;</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>但是我们怎么排查这个问题呢？ 到底跟哪条SQL产生了死锁？</p><h1 id="死锁日志" tabindex="-1"><a class="header-anchor" href="#死锁日志"><span>死锁日志</span></a></h1><p>好在MySQL记录了最近一次的死锁日志，可以用命令行工具查看：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">show</span> <span class="token keyword">engine</span> <span class="token keyword">innodb</span> <span class="token keyword">status</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="https://cdn.nlark.com/yuque/0/2023/png/12651402/1686487291124-bb1a49d7-ca91-4f73-bfba-f2fc8c692334.png#averageHue=%23344657&amp;clientId=u4c0071e8-710e-4&amp;from=paste&amp;height=2986&amp;id=uaa0404ba&amp;originHeight=2986&amp;originWidth=1892&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=851902&amp;status=done&amp;style=none&amp;taskId=ubd0456d6-3a35-4f25-ae76-bc25018e226&amp;title=&amp;width=1892" alt="死锁日志.png" loading="lazy"> 在死锁日志中，可以清楚地看到这两条insert语句产生了死锁，最终事务2被会回滚，事务1执行成功。</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment"># 事务1</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">user</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>age<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">&#39;张三&#39;</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 事务2</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">user</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>age<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token string">&#39;李四&#39;</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这两条insert语句，怎么看也不像能产生死锁，我们来还原一下事发过程。</p><h1 id="排查过程" tabindex="-1"><a class="header-anchor" href="#排查过程"><span>排查过程</span></a></h1><p>先看一下对应的Java代码：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insertUser</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">User</span> userResult <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectByIdForUpdate</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果userId不存在，就插入数据，否则更新</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>userResult <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        userMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        userMapper<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>业务逻辑代码很简单，如果userId不存在，就插入数据，否则更新user对象数据。 从死锁日志中，我们看到有两条insert语句，很明显userId=5和userId=6的数据都不存在。 所以对应的SQL执行过程，可能就是这样的： <img src="https://cdn.nlark.com/yuque/0/2023/png/12651402/1686487303759-a085b0d2-76fd-4d29-8ead-a0d0315dcabc.png#averageHue=%23efeeee&amp;clientId=u4c0071e8-710e-4&amp;from=paste&amp;height=347&amp;id=u09e4a2a7&amp;originHeight=347&amp;originWidth=756&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=79390&amp;status=done&amp;style=none&amp;taskId=u142ab8e0-ca6a-4db1-a584-85b8dcc6d1d&amp;title=&amp;width=756" alt="image-20220608174554212.png" loading="lazy"> 先用for update加上排他锁，防止其他事务修改当前数据，然后再insert数据，最后发生了死锁，事务2被回滚。 两个事务分别在两个主键ID上面加锁，为什么会产生死锁呢？</p><h1 id="底层原理" tabindex="-1"><a class="header-anchor" href="#底层原理"><span>底层原理</span></a></h1><p>如果看过上篇文章，就会明白。 当id=5存在这条数据时，MySQL就会加<strong>Record Locks（记录锁）</strong>，意思就是只在id=5这一条记录上加锁。 当id=5这条记录不存在时，就会锁定一个范围 假设表中的记录是这样的：</p><table><thead><tr><th>id</th><th>name</th><th>age</th></tr></thead><tbody><tr><td>1</td><td>王二</td><td>1</td></tr><tr><td>10</td><td>一灯</td><td>10</td></tr></tbody></table><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">5</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这条select语句锁定范围就是 <strong>(1, 10]</strong>。 最后两个事务的执行过程就变成了： <img src="https://cdn.nlark.com/yuque/0/2023/png/12651402/1686487321161-516f966a-a14d-4580-8dbd-7ddac5f2d751.png#averageHue=%23f0efee&amp;clientId=u4c0071e8-710e-4&amp;from=paste&amp;height=400&amp;id=yuEaF&amp;originHeight=400&amp;originWidth=760&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=104586&amp;status=done&amp;style=none&amp;taskId=u138a0284-6ad0-4a81-9f9b-cb414a7280f&amp;title=&amp;width=760" alt="image-20220608180913949.png" loading="lazy"> 通过这个示例看到，两个事务都可以先后锁定 **(1, 10]**这个范围，说明MySQL默认加的临键锁的范围是可以交叉的。 那怎么解决这个死锁问题呢？ 我能想到的解决办法就是，把这两个语句select和insert，合并成一条语句：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">user</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>age<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">&#39;张三&#39;</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span>
	<span class="token keyword">on</span> <span class="token keyword">duplicate</span> <span class="token keyword">key</span> <span class="token keyword">update</span> name<span class="token operator">=</span><span class="token string">&#39;张三&#39;</span><span class="token punctuation">,</span>age<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>大家有什么好办法吗？ 这个死锁情况，还是挺常见的，赶紧回去翻一下项目代码有没有这样的问题。</p>`,21),o=[p];function i(c,l){return n(),s("div",null,o)}const u=a(t,[["render",i],["__file","dead.html.vue"]]),k=JSON.parse('{"path":"/mysql/dead.html","title":"死锁现象","lang":"zh-CN","frontmatter":{"description":"死锁现象 线上MySQL死锁了，我赶紧登录线上系统，查看业务日志。 image-20220608112347888.png 能清楚看到是这条insert语句发生了死锁。 MySQL如果检测到两个事务发生了死锁，会回滚其中一个事务，让另一个事务执行成功。很明显，我们这条insert语句被回滚了。 但是我们怎么排查这个问题呢？ 到底跟哪条SQL产生了死锁？...","head":[["meta",{"property":"og:url","content":"https://vuepress-theme-hope-docs-demo.netlify.app/mysql/dead.html"}],["meta",{"property":"og:site_name","content":"Java八股文网"}],["meta",{"property":"og:title","content":"死锁现象"}],["meta",{"property":"og:description","content":"死锁现象 线上MySQL死锁了，我赶紧登录线上系统，查看业务日志。 image-20220608112347888.png 能清楚看到是这条insert语句发生了死锁。 MySQL如果检测到两个事务发生了死锁，会回滚其中一个事务，让另一个事务执行成功。很明显，我们这条insert语句被回滚了。 但是我们怎么排查这个问题呢？ 到底跟哪条SQL产生了死锁？..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://cdn.nlark.com/yuque/0/2023/png/12651402/1686487279908-fb9503ee-dc2e-45a5-9332-b29e80dd4e2a.png#averageHue=%23384656&clientId=u4c0071e8-710e-4&from=paste&height=752&id=ub2cf7df7&originHeight=752&originWidth=1262&originalType=binary&ratio=1&rotation=0&showTitle=false&size=963676&status=done&style=none&taskId=u61a98b77-4b6d-4707-9f33-b3e04d5c600&title=&width=1262"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"article:author","content":"Mr.Hope"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"死锁现象\\",\\"image\\":[\\"https://cdn.nlark.com/yuque/0/2023/png/12651402/1686487279908-fb9503ee-dc2e-45a5-9332-b29e80dd4e2a.png#averageHue=%23384656&clientId=u4c0071e8-710e-4&from=paste&height=752&id=ub2cf7df7&originHeight=752&originWidth=1262&originalType=binary&ratio=1&rotation=0&showTitle=false&size=963676&status=done&style=none&taskId=u61a98b77-4b6d-4707-9f33-b3e04d5c600&title=&width=1262\\",\\"https://cdn.nlark.com/yuque/0/2023/png/12651402/1686487291124-bb1a49d7-ca91-4f73-bfba-f2fc8c692334.png#averageHue=%23344657&clientId=u4c0071e8-710e-4&from=paste&height=2986&id=uaa0404ba&originHeight=2986&originWidth=1892&originalType=binary&ratio=1&rotation=0&showTitle=false&size=851902&status=done&style=none&taskId=ubd0456d6-3a35-4f25-ae76-bc25018e226&title=&width=1892\\",\\"https://cdn.nlark.com/yuque/0/2023/png/12651402/1686487303759-a085b0d2-76fd-4d29-8ead-a0d0315dcabc.png#averageHue=%23efeeee&clientId=u4c0071e8-710e-4&from=paste&height=347&id=u09e4a2a7&originHeight=347&originWidth=756&originalType=binary&ratio=1&rotation=0&showTitle=false&size=79390&status=done&style=none&taskId=u142ab8e0-ca6a-4db1-a584-85b8dcc6d1d&title=&width=756\\",\\"https://cdn.nlark.com/yuque/0/2023/png/12651402/1686487321161-516f966a-a14d-4580-8dbd-7ddac5f2d751.png#averageHue=%23f0efee&clientId=u4c0071e8-710e-4&from=paste&height=400&id=yuEaF&originHeight=400&originWidth=760&originalType=binary&ratio=1&rotation=0&showTitle=false&size=104586&status=done&style=none&taskId=u138a0284-6ad0-4a81-9f9b-cb414a7280f&title=&width=760\\"],\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Mr.Hope\\",\\"url\\":\\"https://mister-hope.com\\"}]}"]]},"headers":[],"git":{"createdTime":null,"updatedTime":null,"contributors":[]},"readingTime":{"minutes":3.06,"words":918},"filePathRelative":"mysql/dead.md","autoDesc":true}');export{u as comp,k as data};
